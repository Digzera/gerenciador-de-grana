<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Gerenciador Financeiro v2.0</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #374151; /* text-gray-700 */
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-lg */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .input-field {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            width: 100%;
            font-size: 1rem;
            color: #374151;
            background-color: #f9fafb; /* bg-gray-50 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: all 0.2s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-secondary {
            background-color: #6b7280; /* gray-500 */
            color: #ffffff;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: #ffffff;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .day-cell {
            min-height: 100px;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .day-cell:hover { background-color: #f3f4f6; }
        .day-cell.current-month { background-color: #ffffff; }
        .day-cell.other-month { background-color: #f9fafb; color: #9ca3af; }
        .day-cell.has-transactions { border-left: 4px solid #3b82f6; } /* blue-500 */
        .day-cell.selected-day { background-color: #bfdbfe; border-color: #2563eb; } /* blue-200, blue-600 */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 2rem;
            border-radius: 0.75rem; width: 90%; max-width: 500px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            position: relative;
        }
        .close-button {
            color: #aaa; position: absolute; top: 1rem; right: 1rem;
            font-size: 28px; font-weight: bold;
        }
        .close-button:hover, .close-button:focus {
            color: black; text-decoration: none; cursor: pointer;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block; vertical-align: middle; margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background-color: #fff;
            color: #333;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { border-left: 5px solid #22c55e; /* green-500 */ }
        .toast.error { border-left: 5px solid #ef4444; /* red-500 */ }
        .toast-icon { margin-right: 10px; font-size: 1.2rem; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container flex justify-between items-center">
            <h1 class="text-2xl font-bold">Meu Gerenciador Financeiro</h1>
            <div id="user-id-display" class="text-sm bg-indigo-700 px-3 py-1 rounded-full">Carregando...</div>
        </div>
    </header>

    <main class="flex-grow container mt-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Coluna Esquerda: Resumo e Gráfico -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Resumo Financeiro</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span class="font-medium">Receitas Totais:</span>
                            <span id="total-income" class="text-green-600 font-bold text-lg">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                            <span class="font-medium">Despesas Totais:</span>
                            <span id="total-expenses" class="text-red-600 font-bold text-lg">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                            <span class="font-medium text-lg">Balanço Líquido:</span>
                            <span id="net-balance" class="text-blue-600 font-bold text-xl">R$ 0,00</span>
                        </div>
                        <button id="generate-insights-btn" class="btn btn-primary w-full mt-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mr-2" viewBox="0 0 16 16"><path d="M8 1.5a2.5 2.5 0 0 1 2.5 2.5.5.5 0 0 0 .5.5h1.5a.5.5 0 0 0 .5-.5A2.5 2.5 0 0 1 15.5 8a.5.5 0 0 0 .5.5v1.5a.5.5 0 0 0-.5.5A2.5 2.5 0 0 1 13 13.5a.5.5 0 0 0-.5.5v1.5a.5.5 0 0 0 .5.5A2.5 2.5 0 0 1 8 15.5a.5.5 0 0 0-.5.5H6a.5.5 0 0 0-.5-.5A2.5 2.5 0 0 1 3 13.5a.5.5 0 0 0-.5-.5H1a.5.5 0 0 0-.5.5A2.5 2.5 0 0 1 .5 8a.5.5 0 0 0-.5-.5H1.5a.5.5 0 0 0 .5.5A2.5 2.5 0 0 1 5.5 3a.5.5 0 0 0 .5-.5H7.5a.5.5 0 0 0 .5.5zM8 4.5A3.5 3.5 0 1 0 8 11.5A3.5 3.5 0 0 0 8 4.5z"/></svg>
                            Gerar Insights com IA
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Despesas por Categoria</h2>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="expense-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Coluna Direita: Formulário e Calendário -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Adicionar/Editar Transação</h2>
                    <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="transaction-id">
                        <div>
                            <label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                            <input type="date" id="transaction-date" class="input-field" required>
                        </div>
                        <div>
                            <label for="transaction-amount" class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                            <input type="number" id="transaction-amount" class="input-field" step="0.01" min="0" placeholder="0,00" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="transaction-description" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                            <input type="text" id="transaction-description" class="input-field" placeholder="Ex: Salário, Almoço, Aluguel" required>
                        </div>
                        <div>
                            <label for="transaction-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                            <select id="transaction-type" class="input-field" required>
                                <option value="expense">Despesa</option>
                                <option value="income">Receita</option>
                            </select>
                        </div>
                        <div>
                            <label for="transaction-category" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                            <select id="transaction-category" class="input-field" required>
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div class="md:col-span-2 flex justify-end space-x-3">
                            <button type="button" id="cancel-edit-btn" class="btn btn-secondary hidden">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Salvar Transação</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Calendário de Transações</h2>
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="btn btn-secondary">&lt; Mês Anterior</button>
                        <h3 id="current-month-year" class="text-lg font-medium text-center"></h3>
                        <button id="next-month-btn" class="btn btn-secondary">Próximo Mês &gt;</button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center">
                        <!-- Calendar will be rendered here -->
                    </div>
                    <div id="transactions-for-day" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                        <h3 class="text-lg font-semibold mb-3">Transações para <span id="selected-date-display"></span></h3>
                        <div id="daily-transactions-list"></div>
                        <div id="no-daily-transactions" class="text-gray-500 text-center py-4">Nenhuma transação para este dia.</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast container -->
    <div id="toast-container"></div>

    <!-- Modals -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('delete-confirm-modal')">&times;</span>
            <h3 class="text-xl font-semibold mb-4">Confirmar Exclusão</h3>
            <p class="mb-6">Tem certeza que deseja excluir esta transação?</p>
            <div class="flex justify-end space-x-3">
                <button class="btn btn-secondary" onclick="closeModal('delete-confirm-modal')">Cancelar</button>
                <button id="confirm-delete-btn" class="btn btn-danger">Excluir</button>
            </div>
        </div>
    </div>

    <div id="llm-response-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('llm-response-modal')">&times;</span>
            <h3 id="llm-response-title" class="text-xl font-semibold mb-4"></h3>
            <div id="llm-response-content" class="mb-6 whitespace-pre-wrap text-gray-700 max-h-96 overflow-y-auto">
                <div class="spinner mx-auto my-4"></div> Carregando...
            </div>
            <div class="flex justify-end">
                <button class="btn btn-primary" onclick="closeModal('llm-response-modal')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- IMPORTANT SECURITY WARNING ---
        // The Gemini API key is exposed in this client-side code.
        // For a production application, this is a significant security risk.
        // It's highly recommended to use a backend proxy (like a Firebase Cloud Function)
        // to make API calls to Gemini, keeping your API key secure on the server.
        const GEMINI_API_KEY = ""; // Leave empty to use the environment's key, or add your key here for local testing.

        // --- Application State ---
        let app, db, auth, userId;
        let allTransactions = [];
        let currentMonth = new Date();
        let selectedDay = null;
        let expenseChart = null;

        // --- DOM Elements ---
        const elements = {
            userIdDisplay: document.getElementById('user-id-display'),
            totalIncome: document.getElementById('total-income'),
            totalExpenses: document.getElementById('total-expenses'),
            netBalance: document.getElementById('net-balance'),
            transactionForm: document.getElementById('transaction-form'),
            transactionIdInput: document.getElementById('transaction-id'),
            transactionDateInput: document.getElementById('transaction-date'),
            transactionDescriptionInput: document.getElementById('transaction-description'),
            transactionAmountInput: document.getElementById('transaction-amount'),
            transactionTypeInput: document.getElementById('transaction-type'),
            transactionCategoryInput: document.getElementById('transaction-category'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            calendarGrid: document.getElementById('calendar-grid'),
            currentMonthYearDisplay: document.getElementById('current-month-year'),
            transactionsForDaySection: document.getElementById('transactions-for-day'),
            selectedDateDisplay: document.getElementById('selected-date-display'),
            dailyTransactionsList: document.getElementById('daily-transactions-list'),
            noDailyTransactions: document.getElementById('no-daily-transactions'),
            expenseChartCanvas: document.getElementById('expense-chart'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
        };

        const categories = {
            income: ['Salário', 'Vendas', 'Investimentos', 'Freelance', 'Outras Receitas'],
            expense: ['Alimentação', 'Moradia', 'Transporte', 'Lazer', 'Saúde', 'Educação', 'Contas', 'Compras', 'Impostos', 'Outras Despesas']
        };

        // --- Toast Notification Logic ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? '✅' : '❌';
            toast.innerHTML = `<span class="toast-icon">${icon}</span> ${message}`;
            container.appendChild(toast);

            // Animate in
            setTimeout(() => toast.classList.add('show'), 10);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 300);
            }, 4000);
        }

        // --- Modal Logic ---
        window.openModal = (modalId) => document.getElementById(modalId).style.display = 'flex';
        window.closeModal = (modalId) => document.getElementById(modalId).style.display = 'none';

        // --- Formatting ---
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        
        // --- Category Population ---
        function populateCategories() {
            const type = elements.transactionTypeInput.value;
            const categoryList = categories[type];
            elements.transactionCategoryInput.innerHTML = '<option value="">Selecione...</option>';
            categoryList.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                elements.transactionCategoryInput.appendChild(option);
            });
        }

        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await setPersistence(auth, browserLocalPersistence);
                
                try {
                    await enableIndexedDbPersistence(db);
                } catch (err) {
                    console.warn("Persistência offline do Firestore desabilitada:", err.code);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        elements.userIdDisplay.textContent = `Usuário: ${userId.substring(0, 8)}...`;
                        setupRealtimeListener();
                    } else {
                        // If no user, try to sign in
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                elements.userIdDisplay.textContent = 'Erro de Conexão';
                showToast("Não foi possível conectar ao servidor.", "error");
            }
        }

        // --- Real-time Data Listener ---
        function setupRealtimeListener() {
            if (!db || !userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/transactions`));

            onSnapshot(q, (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date.toDate()
                })).sort((a, b) => b.date - a.date); // Sort in memory

                updateUI();
            }, (error) => {
                console.error("Erro ao buscar transações:", error);
                showToast("Erro ao carregar transações.", "error");
            });
        }

        // --- UI Update Functions ---
        function updateUI() {
            updateDashboard();
            renderCalendar();
            updateExpenseChart();
            if (selectedDay) {
                displayTransactionsForDay(selectedDay);
            }
        }

        function updateDashboard() {
            const totalIncome = allTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = allTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            elements.totalIncome.textContent = formatCurrency(totalIncome);
            elements.totalExpenses.textContent = formatCurrency(totalExpenses);
            elements.netBalance.textContent = formatCurrency(totalIncome - totalExpenses);
        }

        function updateExpenseChart() {
            const expenseData = allTransactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            const labels = Object.keys(expenseData);
            const data = Object.values(expenseData);

            if (expenseChart) {
                expenseChart.data.labels = labels;
                expenseChart.data.datasets[0].data = data;
                expenseChart.update();
            } else if (labels.length > 0) {
                expenseChart = new Chart(elements.expenseChartCanvas, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    boxWidth: 12
                                }
                            }
                        }
                    }
                });
            }
        }

        // --- Calendar Logic ---
        function renderCalendar() {
            elements.calendarGrid.innerHTML = `
                <div class="font-bold text-gray-600 p-2 text-xs">DOM</div>
                <div class="font-bold text-gray-600 p-2 text-xs">SEG</div>
                <div class="font-bold text-gray-600 p-2 text-xs">TER</div>
                <div class="font-bold text-gray-600 p-2 text-xs">QUA</div>
                <div class="font-bold text-gray-600 p-2 text-xs">QUI</div>
                <div class="font-bold text-gray-600 p-2 text-xs">SEX</div>
                <div class="font-bold text-gray-600 p-2 text-xs">SAB</div>
            `;

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            elements.currentMonthYearDisplay.textContent = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' }).format(currentMonth);

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                elements.calendarGrid.insertAdjacentHTML('beforeend', '<div class="day-cell other-month"></div>');
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const dailyTransactions = allTransactions.filter(t => t.date.toISOString().split('T')[0] === dateString);
                
                const cell = document.createElement('div');
                cell.className = 'day-cell current-month';
                cell.dataset.date = dateString;
                cell.innerHTML = `<span class="font-bold text-sm self-start">${day}</span>`;

                if (dailyTransactions.length > 0) {
                    cell.classList.add('has-transactions');
                    const total = dailyTransactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
                    const colorClass = total >= 0 ? 'text-green-600' : 'text-red-600';
                    cell.insertAdjacentHTML('beforeend', `<span class="text-xs font-semibold ${colorClass} self-end">${formatCurrency(Math.abs(total))}</span>`);
                }
                
                if (dateString === selectedDay) {
                    cell.classList.add('selected-day');
                }

                cell.addEventListener('click', () => {
                    if (selectedDay) {
                        document.querySelector(`.day-cell[data-date="${selectedDay}"]`)?.classList.remove('selected-day');
                    }
                    selectedDay = dateString;
                    cell.classList.add('selected-day');
                    displayTransactionsForDay(dateString);
                });
                elements.calendarGrid.appendChild(cell);
            }
        }

        function displayTransactionsForDay(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            const dateObj = new Date(year, month - 1, day);
            elements.selectedDateDisplay.textContent = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full' }).format(dateObj);
            elements.dailyTransactionsList.innerHTML = '';
            elements.transactionsForDaySection.classList.remove('hidden');

            const transactions = allTransactions.filter(t => t.date.toISOString().split('T')[0] === dateString);

            if (transactions.length === 0) {
                elements.noDailyTransactions.classList.remove('hidden');
            } else {
                elements.noDailyTransactions.classList.add('hidden');
                transactions.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 border-b last:border-b-0';
                    div.innerHTML = `
                        <div>
                            <p class="font-medium">${t.description} <span class="text-gray-500 text-sm">(${t.category})</span></p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">${formatCurrency(t.amount)}</span>
                            <button class="text-blue-500 hover:text-blue-700 text-sm font-semibold" onclick="window.editTransaction('${t.id}')">Editar</button>
                            <button class="text-red-500 hover:text-red-700 text-sm font-semibold" onclick="window.confirmDeleteTransaction('${t.id}')">Excluir</button>
                        </div>`;
                    elements.dailyTransactionsList.appendChild(div);
                });
            }
        }

        // --- Transaction Management (CRUD) ---
        function resetTransactionForm() {
            elements.transactionForm.reset();
            elements.transactionIdInput.value = '';
            elements.transactionDateInput.value = new Date().toISOString().split('T')[0];
            elements.transactionForm.querySelector('button[type="submit"]').textContent = 'Salvar Transação';
            elements.cancelEditBtn.classList.add('hidden');
            populateCategories();
        }

        elements.transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = elements.transactionIdInput.value;
            const date = new Date(elements.transactionDateInput.value + 'T00:00:00'); // Avoid timezone issues

            const transactionData = {
                date,
                description: elements.transactionDescriptionInput.value,
                amount: parseFloat(elements.transactionAmountInput.value),
                type: elements.transactionTypeInput.value,
                category: elements.transactionCategoryInput.value,
                timestamp: serverTimestamp()
            };
            
            if (!transactionData.description || isNaN(transactionData.amount) || !transactionData.category) {
                showToast("Por favor, preencha todos os campos.", "error");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                if (id) {
                    await updateDoc(doc(collectionRef, id), transactionData);
                    showToast("Transação atualizada com sucesso!");
                } else {
                    await addDoc(collectionRef, transactionData);
                    showToast("Transação adicionada com sucesso!");
                }
                resetTransactionForm();
            } catch (error) {
                console.error("Erro ao salvar transação:", error);
                showToast("Erro ao salvar transação.", "error");
            }
        });

        window.editTransaction = (id) => {
            const t = allTransactions.find(t => t.id === id);
            if (t) {
                elements.transactionIdInput.value = t.id;
                elements.transactionDateInput.value = t.date.toISOString().split('T')[0];
                elements.transactionDescriptionInput.value = t.description;
                elements.transactionAmountInput.value = t.amount;
                elements.transactionTypeInput.value = t.type;
                populateCategories(); // Populate categories for the correct type first
                elements.transactionCategoryInput.value = t.category;
                elements.transactionForm.querySelector('button[type="submit"]').textContent = 'Atualizar Transação';
                elements.cancelEditBtn.classList.remove('hidden');
                elements.transactionForm.scrollIntoView({ behavior: 'smooth' });
            }
        };

        let transactionToDeleteId = null;
        window.confirmDeleteTransaction = (id) => {
            transactionToDeleteId = id;
            openModal('delete-confirm-modal');
        };

        elements.confirmDeleteBtn.addEventListener('click', async () => {
            if (transactionToDeleteId) {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, transactionToDeleteId));
                    showToast("Transação excluída com sucesso!");
                    closeModal('delete-confirm-modal');
                    transactionToDeleteId = null;
                } catch (error) {
                    console.error("Erro ao excluir transação:", error);
                    showToast("Erro ao excluir transação.", "error");
                }
            }
        });

        // --- Gemini AI Integration ---
        async function callGemini(prompt) {
            const llmModal = document.getElementById('llm-response-modal');
            const llmContent = document.getElementById('llm-response-content');
            llmContent.innerHTML = '<div class="spinner mx-auto my-4"></div> Carregando...';
            openModal('llm-response-modal');

            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    llmContent.textContent = text;
                } else {
                    throw new Error("Resposta da API inválida.");
                }
            } catch (error) {
                console.error("Erro na chamada da API Gemini:", error);
                llmContent.textContent = "Ocorreu um erro ao processar sua solicitação. Verifique o console para mais detalhes.";
            }
        }

        document.getElementById('generate-insights-btn').addEventListener('click', () => {
            if (allTransactions.length < 3) {
                showToast("Adicione pelo menos 3 transações para gerar insights.", "error");
                return;
            }
            const summary = allTransactions.map(t => 
                `- ${t.type === 'income' ? 'Receita' : 'Despesa'} de ${formatCurrency(t.amount)} em ${t.category} (${t.description}) no dia ${t.date.toLocaleDateString('pt-BR')}`
            ).join('\n');
            const prompt = `Sou um usuário de um app de finanças e estes são meus últimos lançamentos:\n\n${summary}\n\nCom base nisso, aja como um consultor financeiro amigável e me dê uma breve análise (2-3 parágrafos). Destaque meus principais gastos, sugira 1 ou 2 áreas onde posso economizar e me dê uma dica geral para melhorar minha saúde financeira. Seja conciso e motivador.`;
            
            document.getElementById('llm-response-title').textContent = "Insights Financeiros";
            callGemini(prompt);
        });

        // --- Event Listeners and Initial Setup ---
        window.onload = () => {
            initializeFirebase();
            resetTransactionForm();
        };

        elements.transactionTypeInput.addEventListener('change', populateCategories);
        elements.cancelEditBtn.addEventListener('click', resetTransactionForm);
        document.getElementById('prev-month-btn').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            selectedDay = null;
            elements.transactionsForDaySection.classList.add('hidden');
            renderCalendar();
        });
        document.getElementById('next-month-btn').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            selectedDay = null;
            elements.transactionsForDaySection.classList.add('hidden');
            renderCalendar();
        });

    </script>
</body>
</html>
